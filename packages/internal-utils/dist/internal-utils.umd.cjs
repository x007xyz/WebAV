(function(u,l){typeof exports=="object"&&typeof module<"u"?l(exports,require("@webav/mp4box.js")):typeof define=="function"&&define.amd?define(["exports","@webav/mp4box.js"],l):(u=typeof globalThis<"u"?globalThis:u||self,l(u["av-internal-utils"]={},u.mp4box))})(this,function(u,l){"use strict";var se=Object.defineProperty;var P=u=>{throw TypeError(u)};var ae=(u,l,T)=>l in u?se(u,l,{enumerable:!0,configurable:!0,writable:!0,value:T}):u[l]=T;var I=(u,l,T)=>ae(u,typeof l!="symbol"?l+"":l,T),ce=(u,l,T)=>l.has(u)||P("Cannot "+T);var x=(u,l,T)=>(ce(u,l,"read from private field"),T?T.call(u):l.get(u)),j=(u,l,T)=>l.has(u)?P("Cannot add the same private member more than once"):l instanceof WeakSet?l.add(u):l.set(u,T);var k;class T{constructor(){j(this,k,new Map);I(this,"on",(t,n)=>{const r=x(this,k).get(t)??new Set;return r.add(n),x(this,k).has(t)||x(this,k).set(t,r),()=>{r.delete(n),r.size===0&&x(this,k).delete(t)}});I(this,"once",(t,n)=>{const r=this.on(t,(...o)=>{r(),n(...o)});return r});I(this,"emit",(t,...n)=>{const r=x(this,k).get(t);r!=null&&r.forEach(o=>o(...n))})}static forwardEvent(t,n,r){const o=r.map(s=>{const[a,i]=Array.isArray(s)?s:[s,s];return t.on(a,(...d)=>{n.emit(i,...d)})});return()=>{o.forEach(s=>s())}}destroy(){x(this,k).clear()}}k=new WeakMap;const Q=()=>{let e,t=16.6;self.onmessage=n=>{n.data.event==="start"&&(self.clearInterval(e),e=self.setInterval(()=>{self.postMessage({})},t)),n.data.event==="stop"&&self.clearInterval(e)}},H=()=>{const e=new Blob([`(${Q.toString()})()`]),t=URL.createObjectURL(e);return new Worker(t)},R=new Map;let E=1,z=null;globalThis.Worker!=null&&(z=H(),z.onmessage=()=>{E+=1;for(const[e,t]of R)if(E%e===0)for(const n of t)n()});const V=(e,t)=>{const n=Math.round(t/16.6),r=R.get(n)??new Set;return r.add(e),R.set(n,r),R.size===1&&r.size===1&&(z==null||z.postMessage({event:"start"})),()=>{r.delete(e),r.size===0&&R.delete(n),R.size===0&&(E=0,z==null||z.postMessage({event:"stop"}))}};function J(e,t){let n=!1;async function r(){const o=e.getReader();for(;!n;){const{value:s,done:a}=await o.read();if(a){t.onDone();return}await t.onChunk(s)}o.releaseLock(),await e.cancel()}return r().catch(console.error),()=>{n=!0}}function q(e,t,n){let r=0,o=0;const s=e.boxes;let a=!1;const i=()=>{var w;if(!a)if(s.find(b=>b.type==="moof")!=null)a=!0;else return null;if(o>=s.length)return null;const f=new l.DataStream;f.endianness=l.DataStream.BIG_ENDIAN;let y=o;try{for(;y<s.length;)s[y].write(f),delete s[y],y+=1}catch(b){const D=s[y];throw b instanceof Error&&D!=null?Error(`${b.message} | deltaBuf( boxType: ${D.type}, boxSize: ${D.size}, boxDataLen: ${((w=D.data)==null?void 0:w.length)??-1})`):b}return W(e),o=s.length,new Uint8Array(f.buffer)};let d=!1,c=!1,g=null;return{stream:new ReadableStream({start(f){r=self.setInterval(()=>{const y=i();y!=null&&!c&&f.enqueue(y)},t),g=y=>{if(clearInterval(r),e.flush(),y!=null){f.error(y);return}const w=i();w!=null&&!c&&f.enqueue(w),c||f.close()},d&&g()},cancel(){c=!0,clearInterval(r),n==null||n()}}),stop:f=>{d||(d=!0,g==null||g(f))}}}function W(e){if(e.moov!=null){for(var t=0;t<e.moov.traks.length;t++)e.moov.traks[t].samples=[];e.mdats=[],e.moofs=[]}}const M=(e,t)=>{const n=new Uint8Array(8);new DataView(n.buffer).setUint32(0,t);for(let o=0;o<4;o++)n[4+o]=e.charCodeAt(o);return n},F=()=>{const e=new TextEncoder,t=e.encode("mdta"),n=e.encode("mp4 handler"),r=32+n.byteLength+1,o=new Uint8Array(r),s=new DataView(o.buffer);return o.set(M("hdlr",r),0),s.setUint32(8,0),o.set(t,16),o.set(n,32),o},G=e=>{const t=new TextEncoder,n=t.encode("mdta"),r=e.map(c=>{const g=t.encode(c),m=8+g.byteLength,f=new Uint8Array(m);return new DataView(f.buffer).setUint32(0,m),f.set(n,4),f.set(g,4+n.byteLength),f}),s=16+r.reduce((c,g)=>c+g.byteLength,0),a=new Uint8Array(s),i=new DataView(a.buffer);a.set(M("keys",s),0),i.setUint32(8,0),i.setUint32(12,e.length);let d=16;for(const c of r)a.set(c,d),d+=c.byteLength;return a},K=e=>{const t=new TextEncoder,n=t.encode("data"),r=Object.entries(e).map(([d,c],g)=>{const m=g+1,f=t.encode(c),y=24+f.byteLength,w=new Uint8Array(y),b=new DataView(w.buffer);return b.setUint32(0,y),b.setUint32(4,m),b.setUint32(8,16+f.byteLength),w.set(n,12),b.setUint32(16,1),w.set(f,24),w}),s=8+r.reduce((d,c)=>d+c.byteLength,0),a=new Uint8Array(s);a.set(M("ilst",s),0);let i=8;for(const d of r)a.set(d,i),i+=d.byteLength;return a},X=e=>{const t=F(),n=G(Object.keys(e)),r=K(e),o=t.length+n.length+r.length,s=new Uint8Array(o);return s.set(t,0),s.set(n,t.length),s.set(r,t.length+n.length),s};function Y(e){return e instanceof Error?String(e):typeof e=="object"?JSON.stringify(e,(t,n)=>n instanceof Error?String(n):n):String(e)}function Z(){const e=new Date;return`${e.getHours()}:${e.getMinutes()}:${e.getSeconds()}.${e.getMilliseconds()}`}let _=1;const C=[],O=["debug","info","warn","error"].reduce((e,t,n)=>Object.assign(e,{[t]:(...r)=>{_<=n&&(console[t](...r),C.push({lvName:t,timeStr:Z(),args:r}))}}),{}),$=new Map,p={setLogLevel:e=>{_=$.get(e)??1},...O,create:e=>Object.fromEntries(Object.entries(O).map(([t,n])=>[t,(...r)=>n(e,...r)])),async dump(){return C.reduce((e,{lvName:t,timeStr:n,args:r})=>e+`[${t}][${n}]  ${r.map(o=>Y(o)).join(" ")}
`,"")}};$.set(p.debug,0),$.set(p.info,1),$.set(p.warn,2),$.set(p.error,3),async function(){await Promise.resolve(),!(globalThis.navigator==null||globalThis.document==null)&&(p.info(`@webav version: 1.1.1, date: ${new Date().toLocaleDateString()}`),p.info(globalThis.navigator.userAgent),document.addEventListener("visibilitychange",()=>{p.info(`visibilitychange: ${document.visibilityState}`)}),"PressureObserver"in globalThis&&new PressureObserver(n=>{p.info(`cpu state change: ${JSON.stringify(n.map(r=>r.state))}`)}).observe("cpu"))}();function ee(e){p.info("recodemux opts:",e);const t=l.createFile(),n=new T,r=(d,c)=>{const m=d.add("udta").add("meta");m.data=X(c),m.size=m.data.byteLength};let o=!1;const s=()=>{t.moov==null||o||(o=!0,e.metaDataTags!=null&&r(t.moov,e.metaDataTags),e.duration!=null&&(t.moov.mvhd.duration=e.duration))};n.once("VideoReady",s),n.once("AudioReady",s);let a=e.video!=null?te(e.video,t,n):null,i=e.audio!=null?re(e.audio,t,n):null;return e.video==null&&n.emit("VideoReady"),e.audio==null&&n.emit("AudioReady"),{encodeVideo:(d,c)=>{a==null||a.encode(d,c),d.close()},encodeAudio:d=>{if(i!=null)try{i.encode(d),d.close()}catch(c){const g=`encode audio chunk error: ${c.message}, state: ${JSON.stringify({qSize:i.encodeQueueSize,state:i.state})}`;throw p.error(g),Error(g)}},getEncodeQueueSize:()=>(a==null?void 0:a.encodeQueueSize)??(i==null?void 0:i.encodeQueueSize)??0,flush:async()=>{await Promise.all([a==null?void 0:a.flush(),(i==null?void 0:i.state)==="configured"?i.flush():null])},close:()=>{n.destroy(),a==null||a.close(),(i==null?void 0:i.state)==="configured"&&i.close()},mp4file:t}}function te(e,t,n){const r={timescale:1e6,width:e.width,height:e.height,brands:["isom","iso2","avc1","mp42","mp41"],avcDecoderConfigRecord:null,name:"Track created with WebAV"};let o=-1,s=!1;n.once("AudioReady",()=>{s=!0});const a={encoder0:[],encoder1:[]},i=(S,v,A)=>{var h;if(o===-1&&A!=null){const B=(h=A.decoderConfig)==null?void 0:h.description;ne(B),r.avcDecoderConfigRecord=B,o=t.addTrack(r),n.emit("VideoReady"),p.info("VideoEncoder, video track ready, trackId:",o)}a[S].push(U(v))};let d="encoder1",c=0;const g=Math.floor(1e3/e.expectFPS*1e3);function m(){if(!s)return;const S=d==="encoder1"?"encoder0":"encoder1",v=a[d],A=a[S];if(v.length===0&&A.length===0)return;let h=v[0];if(h!=null&&(!h.is_sync||h.cts-c<g)){const L=f(v);L>c&&(c=L)}const B=A[0];if(B!=null&&B.is_sync&&B.cts-c<g){d=S,m();return}if(h!=null&&h.is_sync&&(B!=null&&B.is_sync))if(h.cts<=B.cts){const L=f(v);L>c&&(c=L)}else{d=S,m();return}}function f(S){let v=-1,A=0;for(;A<S.length;A++){const h=S[A];if(A>0&&h.is_sync)break;t.addSample(o,h.data,h),v=h.cts+h.duration}return S.splice(0,A),v}const y=V(m,15),w=N(e,(S,v)=>i("encoder0",S,v)),b=N(e,(S,v)=>i("encoder1",S,v));let D=0;return{get encodeQueueSize(){return w.encodeQueueSize+b.encodeQueueSize},encode:(S,v)=>{try{v.keyFrame&&(D+=1),(D%2===0?w:b).encode(S,v)}catch(A){const h=`encode video frame error: ${A.message}, state: ${JSON.stringify({ts:S.timestamp,keyFrame:v.keyFrame,duration:S.duration,gopId:D})}`;throw p.error(h),Error(h)}},flush:async()=>{await Promise.all([w.state==="configured"?await w.flush():null,b.state==="configured"?await b.flush():null]),y(),m()},close:()=>{w.state==="configured"&&w.close(),b.state==="configured"&&b.close()}}}function ne(e){const t=new Uint8Array(e);t[2].toString(2).slice(-2).includes("1")&&(t[2]=0)}function N(e,t){const n={codec:e.codec,framerate:e.expectFPS,hardwareAcceleration:e.__unsafe_hardwareAcceleration__,bitrate:e.bitrate,width:e.width,height:e.height,alpha:"discard",avc:{format:"avc"}},r=new VideoEncoder({error:o=>{const s=`VideoEncoder error: ${o.message}, config: ${JSON.stringify(n)}, state: ${JSON.stringify({qSize:r.encodeQueueSize,state:r.state})}`;throw p.error(s),Error(s)},output:t});return r.configure(n),r}function re(e,t,n){const r={timescale:1e6,samplerate:e.sampleRate,channel_count:e.channelCount,hdlr:"soun",type:e.codec==="aac"?"mp4a":"Opus",name:"Track created with WebAV"};let o=-1,s=[],a=!1;n.once("VideoReady",()=>{a=!0,s.forEach(c=>{const g=U(c);t.addSample(o,g.data,g)}),s=[]});const i={codec:e.codec==="aac"?"mp4a.40.2":"opus",sampleRate:e.sampleRate,numberOfChannels:e.channelCount,bitrate:128e3},d=new AudioEncoder({error:c=>{const g=`AudioEncoder error: ${c.message}, config: ${JSON.stringify(i)}, state: ${JSON.stringify({qSize:d.encodeQueueSize,state:d.state})}`;throw p.error(g),Error(g)},output:(c,g)=>{var m;if(o===-1){const f=(m=g.decoderConfig)==null?void 0:m.description;o=t.addTrack({...r,description:f==null?void 0:oe(f)}),n.emit("AudioReady"),p.info("AudioEncoder, audio track ready, trackId:",o)}if(a){const f=U(c);t.addSample(o,f.data,f)}else s.push(c)}});return d.configure(i),d}function oe(e){const t=e.byteLength,n=new Uint8Array([0,0,0,0,3,23+t,0,2,0,4,18+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5,t,...new Uint8Array(e instanceof ArrayBuffer?e:e.buffer),6,1,2]),r=new l.BoxParser.esdsBox(n.byteLength);return r.hdr_size=0,r.parse(new l.DataStream(n,0,l.DataStream.BIG_ENDIAN)),r}function U(e){const t=new ArrayBuffer(e.byteLength);e.copyTo(t);const n=e.timestamp;return{duration:e.duration??0,dts:n,cts:n,is_sync:e.type==="key",data:t}}u.EventTool=T,u.Log=p,u.autoReadStream=J,u.file2stream=q,u.recodemux=ee,u.workerTimer=V,Object.defineProperty(u,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=internal-utils.umd.cjs.map
