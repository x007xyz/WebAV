(function(v,S){typeof exports=="object"&&typeof module<"u"?S(exports,require("@webav/mp4box.js"),require("@webav/internal-utils"),require("wave-resampler"),require("opfs-tools")):typeof define=="function"&&define.amd?define(["exports","@webav/mp4box.js","@webav/internal-utils","wave-resampler","opfs-tools"],S):(v=typeof globalThis<"u"?globalThis:v||self,S(v["av-cliper"]={},v.mp4box,v.internalUtils,v.waveResampler,v.opfsTools))})(this,function(v,S,g,Se,Bt){"use strict";var xn=Object.defineProperty;var mi=v=>{throw TypeError(v)};var Sn=(v,S,g)=>S in v?xn(v,S,{enumerable:!0,configurable:!0,writable:!0,value:g}):v[S]=g;var k=(v,S,g)=>Sn(v,typeof S!="symbol"?S+"":S,g),Ue=(v,S,g)=>S.has(v)||mi("Cannot "+g);var n=(v,S,g)=>(Ue(v,S,"read from private field"),g?g.call(v):S.get(v)),d=(v,S,g)=>S.has(v)?mi("Cannot add the same private member more than once"):S instanceof WeakSet?S.add(v):S.set(v,g),h=(v,S,g,Se)=>(Ue(v,S,"write to private field"),Se?Se.call(v,g):S.set(v,g),g),L=(v,S,g)=>(Ue(v,S,"access private method"),g);var Ae,Qt,Ut,H,D,X,Kt,$,ot,_t,yt,G,_,Mt,E,Ct,vt,qt,xt,J,M,ct,St,Lt,Zt,zt,lt,te,Tt,ee,ie,ne,j,At,Y,it,z,Vt,se,re,ke,Ie,O,V,F,Re,pi,It,nt,ht,Q,Fe,wi,dt,U,Rt,ae,Nt,Ht,P,oe,N,K,q,B,rt,at,Pe,gi,le,he,de,ue,fe,me,pe,ut,Yt,ft,we,Ft,$t,mt,Z,Et,pt,ge,jt,wt,Pt,Wt,ye,Ke,Dt,be,tt,Ce,W,Xt,ve,xe,Ot,Gt,gt,Jt,yi,bi;function Ci(a){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(a){for(const e in a)if(e!=="default"){const i=Object.getOwnPropertyDescriptor(a,e);Object.defineProperty(t,e,i.get?i:{enumerable:!0,get:()=>a[e]})}}return t.default=a,Object.freeze(t)}const vi=Ci(Se);function xi(a){return document.createElement(a)}function Si(a,t){const e=xi("pre");e.style.cssText=`margin: 0; ${t}; visibility: hidden; position: fixed;`,e.textContent=a,document.body.appendChild(e);const{width:i,height:s}=e.getBoundingClientRect();e.remove(),e.style.visibility="visible";const r=new Image;r.width=i,r.height=s;const o=`
    <svg xmlns="http://www.w3.org/2000/svg" width="${i}" height="${s}">
    <foreignObject width="100%" height="100%">
        <div xmlns="http://www.w3.org/1999/xhtml">${e.outerHTML}</div>
    </foreignObject>
    </svg>
  `.replace(/\t/g,"").replace(/#/g,"%23");return r.src=`data:image/svg+xml;charset=utf-8,${o}`,r}async function Ti(a,t){const e=Si(a,t);await new Promise(r=>{e.onload=r});const i=new OffscreenCanvas(e.width,e.height),s=i.getContext("2d");return s==null||s.drawImage(e,0,0,e.width,e.height),await createImageBitmap(i)}function Ai(a){const t=new Float32Array(a.map(i=>i.length).reduce((i,s)=>i+s));let e=0;for(const i of a)t.set(i,e),e+=i.length;return t}function ki(a){const t=[];for(let e=0;e<a.length;e+=1)for(let i=0;i<a[e].length;i+=1)t[i]==null&&(t[i]=[]),t[i].push(a[e][i]);return t.map(Ai)}function qe(a){if(a.format==="f32-planar"){const t=[];for(let e=0;e<a.numberOfChannels;e+=1){const i=a.allocationSize({planeIndex:e}),s=new ArrayBuffer(i);a.copyTo(s,{planeIndex:e}),t.push(new Float32Array(s))}return t}else if(a.format==="f32"){const t=new ArrayBuffer(a.allocationSize({planeIndex:0}));return a.copyTo(t,{planeIndex:0}),Ri(new Float32Array(t),a.numberOfChannels)}else if(a.format==="s16"){const t=new ArrayBuffer(a.allocationSize({planeIndex:0}));return a.copyTo(t,{planeIndex:0}),Ii(new Int16Array(t),a.numberOfChannels)}throw Error("Unsupported audio data format")}function Ii(a,t){const e=a.length/t,i=Array.from({length:t},()=>new Float32Array(e));for(let s=0;s<e;s++)for(let r=0;r<t;r++){const o=a[s*t+r];i[r][s]=o/32768}return i}function Ri(a,t){const e=a.length/t,i=Array.from({length:t},()=>new Float32Array(e));for(let s=0;s<e;s++)for(let r=0;r<t;r++)i[r][s]=a[s*t+r];return i}function De(a){return Array(a.numberOfChannels).fill(0).map((t,e)=>a.getChannelData(e))}async function Fi(a,t){var o;const e={type:t,data:a},i=new ImageDecoder(e);await Promise.all([i.completed,i.tracks.ready]);let s=((o=i.tracks.selectedTrack)==null?void 0:o.frameCount)??1;const r=[];for(let c=0;c<s;c+=1)r.push((await i.decode({frameIndex:c})).image);return r}function Ze(a){var i,s;const t=Math.max(...a.map(r=>{var o;return((o=r[0])==null?void 0:o.length)??0})),e=new Float32Array(t*2);for(let r=0;r<t;r++){let o=0,c=0;for(let l=0;l<a.length;l++){const m=((i=a[l][0])==null?void 0:i[r])??0,u=((s=a[l][1])==null?void 0:s[r])??m;o+=m,c+=u}e[r]=o,e[r+t]=c}return e}async function Ei(a,t,e){const i=a.length,s=Array(e.chanCount).fill(0).map(()=>new Float32Array(0));if(i===0)return s;const r=Math.max(...a.map(m=>m.length));if(r===0)return s;if(globalThis.OfflineAudioContext==null)return a.map(m=>new Float32Array(vi.resample(m,t,e.rate,{method:"sinc",LPF:!1})));const o=new globalThis.OfflineAudioContext(e.chanCount,r*e.rate/t,e.rate),c=o.createBufferSource(),l=o.createBuffer(i,r,t);return a.forEach((m,u)=>l.copyToChannel(m,u)),c.buffer=l,c.connect(o.destination),c.start(),De(await o.startRendering())}function Oe(a){return new Promise(t=>{const e=g.workerTimer(()=>{e(),t()},a)})}function Be(a,t,e){const i=e-t,s=new Float32Array(i);let r=0;for(;r<i;)s[r]=a[(t+r)%a.length],r+=1;return s}function ti(a,t){const e=Math.floor(a.length/t),i=new Float32Array(e);for(let s=0;s<e;s++){const r=s*t,o=Math.floor(r),c=r-o;o+1<a.length?i[s]=a[o]*(1-c)+a[o+1]*c:i[s]=a[o]}return i}const I={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2"};function _e(a,t){const e=t.videoTracks[0],i={};if(e!=null){const r=Pi(a.getTrackById(e.id)).buffer,{descKey:o,type:c}=e.codec.startsWith("avc1")?{descKey:"avcDecoderConfigRecord",type:"avc1"}:e.codec.startsWith("hvc1")?{descKey:"hevcDecoderConfigRecord",type:"hvc1"}:{descKey:"",type:""};o!==""&&(i.videoTrackConf={timescale:e.timescale,duration:e.duration,width:e.video.width,height:e.video.height,brands:t.brands,type:c,[o]:r}),i.videoDecoderConf={codec:e.codec,codedHeight:e.video.height,codedWidth:e.video.width,description:r}}const s=t.audioTracks[0];if(s!=null){const r=ei(a);i.audioTrackConf={timescale:s.timescale,samplerate:s.audio.sample_rate,channel_count:s.audio.channel_count,hdlr:"soun",type:s.codec.startsWith("mp4a")?"mp4a":s.codec,description:ei(a)},i.audioDecoderConf={codec:s.codec.startsWith("mp4a")?I.codec:s.codec,numberOfChannels:s.audio.channel_count,sampleRate:s.audio.sample_rate,...r==null?{}:Di(r)}}return i}function Pi(a){for(const t of a.mdia.minf.stbl.stsd.entries){const e=t.avcC??t.hvcC??t.av1C??t.vpcC;if(e!=null){const i=new S.DataStream(void 0,0,S.DataStream.BIG_ENDIAN);return e.write(i),new Uint8Array(i.buffer.slice(8))}}throw Error("avcC, hvcC, av1C or VPX not found")}function ei(a,t="mp4a"){var i;const e=(i=a.moov)==null?void 0:i.traks.map(s=>s.mdia.minf.stbl.stsd.entries).flat().find(({type:s})=>s===t);return e==null?void 0:e.esds}function Di(a){var c;const t=(c=a.esd.descs[0])==null?void 0:c.descs[0];if(t==null)return{};const[e,i]=t.data,s=((e&7)<<1)+(i>>7),r=(i&127)>>3;return{sampleRate:[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][s],numberOfChannels:r}}async function Oi(a,t,e){const i=S.createFile(!1);i.onReady=r=>{var l,m;t({mp4boxFile:i,info:r});const o=(l=r.videoTracks[0])==null?void 0:l.id;o!=null&&i.setExtractionOptions(o,"video",{nbSamples:100});const c=(m=r.audioTracks[0])==null?void 0:m.id;c!=null&&i.setExtractionOptions(c,"audio",{nbSamples:100}),i.start()},i.onSamples=e,await s();async function s(){let r=0;const o=30*1024*1024;for(;;){const c=await a.read(o,{at:r});if(c.byteLength===0)break;c.fileStart=r;const l=i.appendBuffer(c);if(l==null)break;r=l}i.stop()}}let Me=0;function Le(a){return a.kind==="file"&&a.createReader instanceof Function}const bt=class bt{constructor(t,e={}){d(this,Ae,Me++);d(this,Qt,g.Log.create(`MP4Clip id:${n(this,Ae)},`));k(this,"ready");d(this,Ut,!1);d(this,H,{duration:0,width:0,height:0,audioSampleRate:0,audioChanCount:0});d(this,D);d(this,X,[]);d(this,Kt,1);d(this,$,[]);d(this,ot,[]);d(this,_t,null);d(this,yt,null);d(this,G,{video:null,audio:null});d(this,_,{audio:!0});k(this,"tickInterceptor",async(t,e)=>e);d(this,Mt,new AbortController);if(!(t instanceof ReadableStream)&&!Le(t)&&!Array.isArray(t.videoSamples))throw Error("Illegal argument");h(this,_,{audio:!0,...e}),h(this,Kt,typeof e.audio=="object"&&"volume"in e.audio?e.audio.volume:1);const i=async s=>(await Bt.write(n(this,D),s),n(this,D));h(this,D,Le(t)?t:"localFile"in t?t.localFile:Bt.tmpfile()),this.ready=(t instanceof ReadableStream?i(t).then(s=>ii(s,n(this,_))):Le(t)?ii(t,n(this,_)):Promise.resolve(t)).then(async({videoSamples:s,audioSamples:r,decoderConf:o,headerBoxPos:c})=>{h(this,$,s),h(this,ot,r),h(this,G,o),h(this,X,c);const{videoFrameFinder:l,audioFrameFinder:m}=_i({video:o.video==null?null:{...o.video,hardwareAcceleration:n(this,_).__unsafe_hardwareAcceleration__},audio:o.audio},await n(this,D).createReader(),s,r,n(this,_).audio!==!1?n(this,Kt):0);return h(this,_t,l),h(this,yt,m),h(this,H,Bi(o,s,r)),n(this,Qt).info("MP4Clip meta:",n(this,H)),{...n(this,H)}})}get meta(){return{...n(this,H)}}async getFileHeaderBinData(){await this.ready;const t=await n(this,D).getOriginFile();if(t==null)throw Error("MP4Clip localFile is not origin file");return await new Blob(n(this,X).map(({start:e,size:i})=>t.slice(e,e+i))).arrayBuffer()}async tick(t){var s,r,o;if(t>=n(this,H).duration)return await this.tickInterceptor(t,{audio:await((s=n(this,yt))==null?void 0:s.find(t))??[],state:"done"});const[e,i]=await Promise.all([((r=n(this,yt))==null?void 0:r.find(t))??[],(o=n(this,_t))==null?void 0:o.find(t)]);return i==null?await this.tickInterceptor(t,{audio:e,state:"success"}):await this.tickInterceptor(t,{video:i,audio:e,state:"success"})}async thumbnails(t=100,e){n(this,Mt).abort(),h(this,Mt,new AbortController);const i=n(this,Mt).signal;await this.ready;const s="generate thumbnails aborted";if(i.aborted)throw Error(s);const{width:r,height:o}=n(this,H),c=Ni(t,Math.round(o*(t/r)),{quality:.1,type:"image/png"});return new Promise(async(l,m)=>{let u=[];const w=n(this,G).video;if(w==null||n(this,$).length===0){p();return}i.addEventListener("abort",()=>{m(Error(s))});async function p(){i.aborted||l(await Promise.all(u.map(async C=>({ts:C.ts,img:await C.img}))))}function x(C){u.push({ts:C.timestamp,img:c(C)})}const{start:f=0,end:y=n(this,H).duration,step:b}=e??{};if(b){let C=f;const T=new ni(await n(this,D).createReader(),n(this,$),{...w,hardwareAcceleration:n(this,_).__unsafe_hardwareAcceleration__});for(;C<=y&&!i.aborted;){const A=await T.find(C);A&&x(A),C+=b}T.destroy(),p()}else await Wi(n(this,$),n(this,D),w,i,{start:f,end:y},(C,T)=>{C!=null&&x(C),T&&p()})})}async split(t){if(await this.ready,t<=0||t>=n(this,H).duration)throw Error('"time" out of bounds');const[e,i]=Hi(n(this,$),t),[s,r]=$i(n(this,ot),t),o=new bt({localFile:n(this,D),videoSamples:e??[],audioSamples:s??[],decoderConf:n(this,G),headerBoxPos:n(this,X)},n(this,_)),c=new bt({localFile:n(this,D),videoSamples:i??[],audioSamples:r??[],decoderConf:n(this,G),headerBoxPos:n(this,X)},n(this,_));return await Promise.all([o.ready,c.ready]),[o,c]}async clone(){await this.ready;const t=new bt({localFile:n(this,D),videoSamples:[...n(this,$)],audioSamples:[...n(this,ot)],decoderConf:n(this,G),headerBoxPos:n(this,X)},n(this,_));return await t.ready,t.tickInterceptor=this.tickInterceptor,t}async splitTrack(){await this.ready;const t=[];if(n(this,$).length>0){const e=new bt({localFile:n(this,D),videoSamples:[...n(this,$)],audioSamples:[],decoderConf:{video:n(this,G).video,audio:null},headerBoxPos:n(this,X)},n(this,_));await e.ready,e.tickInterceptor=this.tickInterceptor,t.push(e)}if(n(this,ot).length>0){const e=new bt({localFile:n(this,D),videoSamples:[],audioSamples:[...n(this,ot)],decoderConf:{audio:n(this,G).audio,video:null},headerBoxPos:n(this,X)},n(this,_));await e.ready,e.tickInterceptor=this.tickInterceptor,t.push(e)}return t}destroy(){var t,e;n(this,Ut)||(n(this,Qt).info("MP4Clip destroy"),h(this,Ut,!0),(t=n(this,_t))==null||t.destroy(),(e=n(this,yt))==null||e.destroy())}};Ae=new WeakMap,Qt=new WeakMap,Ut=new WeakMap,H=new WeakMap,D=new WeakMap,X=new WeakMap,Kt=new WeakMap,$=new WeakMap,ot=new WeakMap,_t=new WeakMap,yt=new WeakMap,G=new WeakMap,_=new WeakMap,Mt=new WeakMap;let ze=bt;function Bi(a,t,e){const i={duration:0,width:0,height:0,audioSampleRate:0,audioChanCount:0};a.video!=null&&t.length>0&&(i.width=a.video.codedWidth??0,i.height=a.video.codedHeight??0),a.audio!=null&&e.length>0&&(i.audioSampleRate=I.sampleRate,i.audioChanCount=I.channelCount);let s=0,r=0;if(t.length>0)for(let o=t.length-1;o>=0;o--){const c=t[o];if(!c.deleted){s=c.cts+c.duration;break}}if(e.length>0){const o=e.at(-1);r=o.cts+o.duration}return i.duration=Math.max(s,r),i}function _i(a,t,e,i,s){return{audioFrameFinder:s===0||a.audio==null||i.length===0?null:new Li(t,i,a.audio,{volume:s,targetSampleRate:I.sampleRate}),videoFrameFinder:a.video==null||e.length===0?null:new ni(t,e,a.video)}}async function ii(a,t={}){let e=null;const i={video:null,audio:null};let s=[],r=[],o=[],c=-1,l=-1;const m=await a.createReader();await Oi(m,p=>{e=p.info;const x=p.mp4boxFile.ftyp;o.push({start:x.start,size:x.size});const f=p.mp4boxFile.moov;o.push({start:f.start,size:f.size});let{videoDecoderConf:y,audioDecoderConf:b}=_e(p.mp4boxFile,p.info);i.video=y??null,i.audio=b??null,y==null&&b==null&&g.Log.error("MP4Clip no video and audio track"),g.Log.info("mp4BoxFile moov ready",{...p.info,tracks:null,videoTracks:null,audioTracks:null},i)},(p,x,f)=>{if(x==="video"){c===-1&&(c=f[0].dts);for(const y of f)s.push(w(y,c,"video"))}else if(x==="audio"&&t.audio){l===-1&&(l=f[0].dts);for(const y of f)r.push(w(y,l,"audio"))}}),await m.close();const u=s.at(-1)??r.at(-1);if(e==null)throw Error("MP4Clip stream is done, but not emit ready");if(u==null)throw Error("MP4Clip stream not contain any sample");return Ne(s),g.Log.info("mp4 stream parsed"),{videoSamples:s,audioSamples:r,decoderConf:i,headerBoxPos:o};function w(p,x=0,f){const y=f==="video"&&p.is_sync?ji(p.data,p.description.type):-1;let b=p.offset,C=p.size;return y>=0&&(b+=y,C-=y),{...p,is_idr:y>=0,offset:b,size:C,cts:(p.cts-x)/p.timescale*1e6,dts:(p.dts-x)/p.timescale*1e6,duration:p.duration/p.timescale*1e6,timescale:1e6,data:f==="video"?null:p.data}}}class ni{constructor(t,e,i){d(this,E,null);d(this,Ct,0);d(this,vt,{abort:!1,st:performance.now()});k(this,"find",async t=>{(n(this,E)==null||n(this,E).state==="closed"||t<=n(this,Ct)||t-n(this,Ct)>3e6)&&n(this,Tt).call(this,t),n(this,vt).abort=!0,h(this,Ct,t),h(this,vt,{abort:!1,st:performance.now()});const e=await n(this,zt).call(this,t,n(this,E),n(this,vt));return h(this,Lt,0),e});d(this,qt,0);d(this,xt,!1);d(this,J,0);d(this,M,[]);d(this,ct,0);d(this,St,0);d(this,Lt,0);d(this,Zt,!1);d(this,zt,async(t,e,i)=>{if(e==null||e.state==="closed"||i.abort)return null;if(n(this,M).length>0){const s=n(this,M)[0];return t<s.timestamp?null:(n(this,M).shift(),t>s.timestamp+(s.duration??0)?(s.close(),await n(this,zt).call(this,t,e,i)):(!n(this,Zt)&&n(this,M).length<10&&n(this,te).call(this,e).catch(r=>{throw h(this,Zt,!0),n(this,Tt).call(this,t),r}),s))}if(n(this,lt)||n(this,ct)<n(this,St)&&e.decodeQueueSize>0){if(performance.now()-i.st>6e3)throw Error(`MP4Clip.tick video timeout, ${JSON.stringify(n(this,ee).call(this))}`);h(this,Lt,n(this,Lt)+1),await Oe(15)}else{if(n(this,J)>=this.samples.length)return null;try{await n(this,te).call(this,e)}catch(s){throw n(this,Tt).call(this,t),s}}return await n(this,zt).call(this,t,e,i)});d(this,lt,!1);d(this,te,async t=>{var s,r;if(n(this,lt)||t.decodeQueueSize>600)return;let e=n(this,J)+1;if(e>this.samples.length)return;h(this,lt,!0);let i=!1;for(;e<this.samples.length;e++){const o=this.samples[e];if(!i&&!o.deleted&&(i=!0),o.is_idr)break}if(i){const o=this.samples.slice(n(this,J),e);if(((s=o[0])==null?void 0:s.is_idr)!==!0)g.Log.warn("First sample not idr frame");else{const c=performance.now(),l=await ri(o,this.localFileReader),m=performance.now()-c;if(m>1e3){const u=o[0],w=o.at(-1),p=w.offset+w.size-u.offset;g.Log.warn(`Read video samples time cost: ${Math.round(m)}ms, file chunk size: ${p}`)}if(t.state==="closed")return;h(this,qt,((r=l[0])==null?void 0:r.duration)??0),Ve(t,l,{onDecodingError:u=>{if(n(this,xt))throw u;n(this,ct)===0&&(h(this,xt,!0),g.Log.warn("Downgrade to software decode"),n(this,Tt).call(this))}}),h(this,St,n(this,St)+l.length)}}h(this,J,e),h(this,lt,!1)});d(this,Tt,t=>{var i,s;if(h(this,lt,!1),n(this,M).forEach(r=>r.close()),h(this,M,[]),t==null||t===0)h(this,J,0);else{let r=0;for(let o=0;o<this.samples.length;o++){const c=this.samples[o];if(c.is_idr&&(r=o),!(c.cts<t)){h(this,J,r);break}}}h(this,St,0),h(this,ct,0),((i=n(this,E))==null?void 0:i.state)!=="closed"&&((s=n(this,E))==null||s.close());const e={...this.conf,...n(this,xt)?{hardwareAcceleration:"prefer-software"}:{}};h(this,E,new VideoDecoder({output:r=>{if(h(this,ct,n(this,ct)+1),r.timestamp===-1){r.close();return}let o=r;r.duration==null&&(o=new VideoFrame(r,{duration:n(this,qt)}),r.close()),n(this,M).push(o)},error:r=>{if(r.message.includes("Codec reclaimed due to inactivity")){h(this,E,null),g.Log.warn(r.message);return}const o=`VideoFinder VideoDecoder err: ${r.message}, config: ${JSON.stringify(e)}, state: ${JSON.stringify(n(this,ee).call(this))}`;throw g.Log.error(o),Error(o)}})),n(this,E).configure(e)});d(this,ee,()=>{var t,e;return{time:n(this,Ct),decState:(t=n(this,E))==null?void 0:t.state,decQSize:(e=n(this,E))==null?void 0:e.decodeQueueSize,decCusorIdx:n(this,J),sampleLen:this.samples.length,inputCnt:n(this,St),outputCnt:n(this,ct),cacheFrameLen:n(this,M).length,softDeocde:n(this,xt),clipIdCnt:Me,sleepCnt:n(this,Lt),memInfo:ai()}});k(this,"destroy",()=>{var t,e;((t=n(this,E))==null?void 0:t.state)!=="closed"&&((e=n(this,E))==null||e.close()),h(this,E,null),n(this,vt).abort=!0,n(this,M).forEach(i=>i.close()),h(this,M,[]),this.localFileReader.close()});this.localFileReader=t,this.samples=e,this.conf=i}}E=new WeakMap,Ct=new WeakMap,vt=new WeakMap,qt=new WeakMap,xt=new WeakMap,J=new WeakMap,M=new WeakMap,ct=new WeakMap,St=new WeakMap,Lt=new WeakMap,Zt=new WeakMap,zt=new WeakMap,lt=new WeakMap,te=new WeakMap,Tt=new WeakMap,ee=new WeakMap;function Mi(a,t){for(let e=0;e<t.length;e++){const i=t[e];if(a>=i.cts&&a<i.cts+i.duration)return e;if(i.cts>a)break}return 0}class Li{constructor(t,e,i,s){d(this,ie,1);d(this,ne);d(this,j,null);d(this,At,{abort:!1,st:performance.now()});k(this,"find",async t=>{const e=t<=n(this,Y)||t-n(this,Y)>1e5;(n(this,j)==null||n(this,j).state==="closed"||e)&&n(this,ke).call(this),e&&(h(this,Y,t),h(this,it,Mi(t,this.samples))),n(this,At).abort=!0;const i=t-n(this,Y);h(this,Y,t),h(this,At,{abort:!1,st:performance.now()});const s=await n(this,se).call(this,Math.ceil(i*(n(this,ne)/1e6)),n(this,j),n(this,At));return h(this,Vt,0),s});d(this,Y,0);d(this,it,0);d(this,z,{frameCnt:0,data:[]});d(this,Vt,0);d(this,se,async(t,e=null,i)=>{if(e==null||i.abort||e.state==="closed"||t===0)return[];const s=n(this,z).frameCnt-t;if(s>0)return s<I.sampleRate/10&&n(this,re).call(this,e),si(n(this,z),t);if(e.decoding){if(performance.now()-i.st>3e3)throw i.abort=!0,Error(`MP4Clip.tick audio timeout, ${JSON.stringify(n(this,Ie).call(this))}`);h(this,Vt,n(this,Vt)+1),await Oe(15)}else{if(n(this,it)>=this.samples.length-1)return si(n(this,z),n(this,z).frameCnt);n(this,re).call(this,e)}return n(this,se).call(this,t,e,i)});d(this,re,t=>{if(t.decodeQueueSize>10)return;const i=[];let s=n(this,it);for(;s<this.samples.length;){const r=this.samples[s];if(s+=1,!r.deleted&&(i.push(r),i.length>=10))break}h(this,it,s),t.decode(i.map(r=>new EncodedAudioChunk({type:"key",timestamp:r.cts,duration:r.duration,data:r.data})))});d(this,ke,()=>{var t;h(this,Y,0),h(this,it,0),h(this,z,{frameCnt:0,data:[]}),(t=n(this,j))==null||t.close(),h(this,j,zi(this.conf,{resampleRate:I.sampleRate,volume:n(this,ie)},e=>{n(this,z).data.push(e),n(this,z).frameCnt+=e[0].length}))});d(this,Ie,()=>{var t,e;return{time:n(this,Y),decState:(t=n(this,j))==null?void 0:t.state,decQSize:(e=n(this,j))==null?void 0:e.decodeQueueSize,decCusorIdx:n(this,it),sampleLen:this.samples.length,pcmLen:n(this,z).frameCnt,clipIdCnt:Me,sleepCnt:n(this,Vt),memInfo:ai()}});k(this,"destroy",()=>{h(this,j,null),n(this,At).abort=!0,h(this,z,{frameCnt:0,data:[]}),this.localFileReader.close()});this.localFileReader=t,this.samples=e,this.conf=i,h(this,ie,s.volume),h(this,ne,s.targetSampleRate)}}ie=new WeakMap,ne=new WeakMap,j=new WeakMap,At=new WeakMap,Y=new WeakMap,it=new WeakMap,z=new WeakMap,Vt=new WeakMap,se=new WeakMap,re=new WeakMap,ke=new WeakMap,Ie=new WeakMap;function zi(a,t,e){let i=0,s=0;const r=u=>{if(s+=1,u.length!==0){if(t.volume!==1)for(const w of u)for(let p=0;p<w.length;p++)w[p]*=t.volume;u.length===1&&(u=[u[0],u[0]]),e(u)}},o=Vi(r),c=t.resampleRate!==a.sampleRate;let l=new AudioDecoder({output:u=>{const w=qe(u);c?o(()=>Ei(w,u.sampleRate,{rate:t.resampleRate,chanCount:u.numberOfChannels})):r(w),u.close()},error:u=>{u.message.includes("Codec reclaimed due to inactivity")||m("MP4Clip AudioDecoder err",u)}});l.configure(a);function m(u,w){const p=`${u}: ${w.message}, state: ${JSON.stringify({qSize:l.decodeQueueSize,state:l.state,inputCnt:i,outputCnt:s})}`;throw g.Log.error(p),Error(p)}return{decode(u){i+=u.length;try{for(const w of u)l.decode(w)}catch(w){m("decode audio chunk error",w)}},close(){l.state!=="closed"&&l.close()},get decoding(){return i>s&&l.decodeQueueSize>0},get state(){return l.state},get decodeQueueSize(){return l.decodeQueueSize}}}function Vi(a){const t=[];let e=0;function i(o,c){t[c]=o,s()}function s(){const o=t[e];o!=null&&(a(o),e+=1,s())}let r=0;return o=>{const c=r;r+=1,o().then(l=>i(l,c)).catch(l=>i(l,c))}}function si(a,t){const e=[new Float32Array(t),new Float32Array(t)];let i=0,s=0;for(;s<a.data.length;){const[r,o]=a.data[s];if(i+r.length>t){const c=t-i;e[0].set(r.subarray(0,c),i),e[1].set(o.subarray(0,c),i),a.data[s][0]=r.subarray(c,r.length),a.data[s][1]=o.subarray(c,o.length);break}else e[0].set(r,i),e[1].set(o,i),i+=r.length,s++}return a.data=a.data.slice(s),a.frameCnt-=t,e}async function ri(a,t){const e=a[0],i=a.at(-1);if(i==null)return[];const s=i.offset+i.size-e.offset;if(s<3e7){const r=new Uint8Array(await t.read(s,{at:e.offset}));return a.map(o=>{const c=o.offset-e.offset;return new EncodedVideoChunk({type:o.is_sync?"key":"delta",timestamp:o.cts,duration:o.duration,data:r.subarray(c,c+o.size)})})}return await Promise.all(a.map(async r=>new EncodedVideoChunk({type:r.is_sync?"key":"delta",timestamp:r.cts,duration:r.duration,data:await t.read(r.size,{at:r.offset})})))}function Ni(a,t,e){const i=new OffscreenCanvas(a,t),s=i.getContext("2d");return async r=>(s.drawImage(r,0,0,a,t),r.close(),await i.convertToBlob(e))}function Hi(a,t){if(a.length===0)return[];let e=0,i=0,s=-1;for(let l=0;l<a.length;l++){const m=a[l];if(s===-1&&t<m.cts&&(s=l-1),m.is_idr)if(s===-1)e=l;else{i=l;break}}const r=a[s];if(r==null)throw Error("Not found video sample by time");const o=a.slice(0,i===0?a.length:i).map(l=>({...l}));for(let l=e;l<o.length;l++){const m=o[l];t<m.cts&&(m.deleted=!0,m.cts=-1)}Ne(o);const c=a.slice(r.is_idr?s:e).map(l=>({...l,cts:l.cts-t}));for(const l of c)l.cts<0&&(l.deleted=!0,l.cts=-1);return Ne(c),[o,c]}function $i(a,t){if(a.length===0)return[];let e=-1;for(let r=0;r<a.length;r++){const o=a[r];if(!(t>o.cts)){e=r;break}}if(e===-1)throw Error("Not found audio sample by time");const i=a.slice(0,e).map(r=>({...r})),s=a.slice(e).map(r=>({...r,cts:r.cts-t}));return[i,s]}function Ve(a,t,e){let i=0;if(a.state==="configured"){for(;i<t.length;i++)a.decode(t[i]);a.flush().catch(s=>{if(!(s instanceof Error))throw s;if(s.message.includes("Decoding error")&&e.onDecodingError!=null){e.onDecodingError(s);return}if(!s.message.includes("Aborted due to close"))throw s})}}function ji(a,t){if(t!=="avc1"&&t!=="hvc1")return 0;const e=new DataView(a.buffer);let i=0;for(;i<a.byteLength-4;){if(t==="avc1"&&(e.getUint8(i+4)&31)===5)return i;if(t==="hvc1"){const s=e.getUint8(i+4)>>1&63;if(s===19||s===20)return i}i+=e.getUint32(i)+4}return-1}async function Wi(a,t,e,i,s,r){const o=await t.createReader(),c=await ri(a.filter(u=>!u.deleted&&u.is_sync&&u.cts>=s.start&&u.cts<=s.end),o);if(c.length===0||i.aborted)return;let l=0;Ve(m(),c,{onDecodingError:u=>{g.Log.warn("thumbnailsByKeyFrame",u),l===0?Ve(m(!0),c,{onDecodingError:w=>{o.close(),g.Log.error("thumbnailsByKeyFrame retry soft deocde",w)}}):(r(null,!0),o.close())}});function m(u=!1){const w={...e,...u?{hardwareAcceleration:"prefer-software"}:{}},p=new VideoDecoder({output:x=>{l+=1;const f=l===c.length;r(x,f),f&&(o.close(),p.state!=="closed"&&p.close())},error:x=>{const f=`thumbnails decoder error: ${x.message}, config: ${JSON.stringify(w)}, state: ${JSON.stringify({qSize:p.decodeQueueSize,state:p.state,outputCnt:l,inputCnt:c.length})}`;throw g.Log.error(f),Error(f)}});return i.addEventListener("abort",()=>{o.close(),p.state!=="closed"&&p.close()}),p.configure(w),p}}function Ne(a){let t=0,e=null;for(const i of a)if(!i.deleted){if(i.is_sync&&(t+=1),t>=2)break;(e==null||i.cts<e.cts)&&(e=i)}e!=null&&e.cts<2e5&&(e.duration+=e.cts,e.cts=0)}function ai(){try{const a=performance.memory;return{jsHeapSizeLimit:a.jsHeapSizeLimit,totalJSHeapSize:a.totalJSHeapSize,usedJSHeapSize:a.usedJSHeapSize,percentUsed:(a.usedJSHeapSize/a.jsHeapSizeLimit).toFixed(3),percentTotal:(a.totalJSHeapSize/a.jsHeapSizeLimit).toFixed(3)}}catch{return{}}}const kt=class kt{constructor(t){d(this,Re);k(this,"ready");d(this,O,{duration:0,width:0,height:0});d(this,V,null);d(this,F,[]);k(this,"tickInterceptor",async(t,e)=>e);const e=i=>(h(this,V,i),n(this,O).width=i.width,n(this,O).height=i.height,n(this,O).duration=1/0,{...n(this,O)});if(t instanceof ReadableStream)this.ready=new Response(t).blob().then(i=>createImageBitmap(i)).then(e);else if(t instanceof ImageBitmap)this.ready=Promise.resolve(e(t));else if(Array.isArray(t)&&t.every(i=>i instanceof VideoFrame)){h(this,F,t);const i=n(this,F)[0];if(i==null)throw Error("The frame count must be greater than 0");h(this,O,{width:i.displayWidth,height:i.displayHeight,duration:n(this,F).reduce((s,r)=>s+(r.duration??0),0)}),this.ready=Promise.resolve({...n(this,O),duration:1/0})}else if("type"in t)this.ready=L(this,Re,pi).call(this,t.stream,t.type).then(()=>({width:n(this,O).width,height:n(this,O).height,duration:1/0}));else throw Error("Illegal arguments")}get meta(){return{...n(this,O)}}async tick(t){if(n(this,V)!=null)return await this.tickInterceptor(t,{video:await createImageBitmap(n(this,V)),state:"success"});const e=t%n(this,O).duration;return await this.tickInterceptor(t,{video:(n(this,F).find(i=>e>=i.timestamp&&e<=i.timestamp+(i.duration??0))??n(this,F)[0]).clone(),state:"success"})}async split(t){if(await this.ready,n(this,V)!=null)return[new kt(await createImageBitmap(n(this,V))),new kt(await createImageBitmap(n(this,V)))];let e=-1;for(let r=0;r<n(this,F).length;r++){const o=n(this,F)[r];if(!(t>o.timestamp)){e=r;break}}if(e===-1)throw Error("Not found frame by time");const i=n(this,F).slice(0,e).map(r=>new VideoFrame(r)),s=n(this,F).slice(e).map(r=>new VideoFrame(r,{timestamp:r.timestamp-t}));return[new kt(i),new kt(s)]}async clone(){await this.ready;const t=n(this,V)==null?n(this,F).map(e=>e.clone()):await createImageBitmap(n(this,V));return new kt(t)}destroy(){var t;g.Log.info("ImgClip destroy"),(t=n(this,V))==null||t.close(),n(this,F).forEach(e=>e.close())}};O=new WeakMap,V=new WeakMap,F=new WeakMap,Re=new WeakSet,pi=async function(t,e){h(this,F,await Fi(t,e));const i=n(this,F)[0];if(i==null)throw Error("No frame available in gif");h(this,O,{duration:n(this,F).reduce((s,r)=>s+(r.duration??0),0),width:i.codedWidth,height:i.codedHeight}),g.Log.info("ImgClip ready:",n(this,O))};let He=kt;const st=class st{constructor(t,e={}){d(this,Fe);k(this,"ready");d(this,It,{duration:0,width:0,height:0});d(this,nt,new Float32Array);d(this,ht,new Float32Array);d(this,Q);k(this,"tickInterceptor",async(t,e)=>e);d(this,dt,0);d(this,U,0);h(this,Q,{loop:!1,volume:1,...e}),this.ready=L(this,Fe,wi).call(this,t).then(()=>({width:0,height:0,duration:e.loop?1/0:n(this,It).duration}))}get meta(){return{...n(this,It),sampleRate:I.sampleRate,chanCount:2}}getPCMData(){return[n(this,nt),n(this,ht)]}async tick(t){if(!n(this,Q).loop&&t>=n(this,It).duration)return await this.tickInterceptor(t,{audio:[],state:"done"});const e=t-n(this,dt);if(t<n(this,dt)||e>3e6)return h(this,dt,t),h(this,U,Math.ceil(n(this,dt)/1e6*I.sampleRate)),await this.tickInterceptor(t,{audio:[new Float32Array(0),new Float32Array(0)],state:"success"});h(this,dt,t);const i=Math.ceil(e/1e6*I.sampleRate),s=n(this,U)+i,r=n(this,Q).loop?[Be(n(this,nt),n(this,U),s),Be(n(this,ht),n(this,U),s)]:[n(this,nt).slice(n(this,U),s),n(this,ht).slice(n(this,U),s)];return h(this,U,s),await this.tickInterceptor(t,{audio:r,state:"success"})}async split(t){await this.ready;const e=Math.ceil(t/1e6*I.sampleRate),i=new st(this.getPCMData().map(r=>r.slice(0,e)),n(this,Q)),s=new st(this.getPCMData().map(r=>r.slice(e)),n(this,Q));return[i,s]}async clone(){await this.ready;const t=new st(this.getPCMData(),n(this,Q));return await t.ready,t}destroy(){h(this,nt,new Float32Array(0)),h(this,ht,new Float32Array(0)),g.Log.info("---- audioclip destroy ----")}};It=new WeakMap,nt=new WeakMap,ht=new WeakMap,Q=new WeakMap,Fe=new WeakSet,wi=async function(t){st.ctx==null&&(st.ctx=new AudioContext({sampleRate:I.sampleRate}));const e=performance.now(),i=t instanceof ReadableStream?await Xi(t,st.ctx):t;g.Log.info("Audio clip decoded complete:",performance.now()-e);const s=n(this,Q).volume;if(s!==1)for(const r of i)for(let o=0;o<r.length;o+=1)r[o]*=s;n(this,It).duration=i[0].length/I.sampleRate*1e6,h(this,nt,i[0]),h(this,ht,i[1]??n(this,nt)),g.Log.info("Audio clip convert to AudioData, time:",performance.now()-e)},dt=new WeakMap,U=new WeakMap,k(st,"ctx",null);let $e=st;async function Xi(a,t){const e=await new Response(a).arrayBuffer();return De(await t.decodeAudioData(e))}const Ee=class Ee{constructor(t){k(this,"ready");d(this,Rt,{duration:0,width:0,height:0});d(this,ae,()=>{});k(this,"audioTrack");d(this,Nt,null);d(this,Ht);h(this,Ht,t),this.audioTrack=t.getAudioTracks()[0]??null,n(this,Rt).duration=1/0;const e=t.getVideoTracks()[0];e!=null?(e.contentHint="motion",this.ready=new Promise(i=>{h(this,ae,Gi(e,s=>{n(this,Rt).width=s.width,n(this,Rt).height=s.height,h(this,Nt,s),i(this.meta)}))})):this.ready=Promise.resolve(this.meta)}get meta(){return{...n(this,Rt)}}async tick(){return{video:n(this,Nt)==null?null:await createImageBitmap(n(this,Nt)),audio:[],state:"success"}}async split(){return[await this.clone(),await this.clone()]}async clone(){return new Ee(n(this,Ht).clone())}destroy(){n(this,Ht).getTracks().forEach(t=>t.stop()),n(this,ae).call(this)}};Rt=new WeakMap,ae=new WeakMap,Nt=new WeakMap,Ht=new WeakMap,k(Ee,"ctx",null);let je=Ee;function Gi(a,t){let e=!1,i;return g.autoReadStream(new MediaStreamTrackProcessor({track:a}).readable,{onChunk:async s=>{if(!e){const{displayHeight:r,displayWidth:o}=s,c=o??0,l=r??0,m=new OffscreenCanvas(c,l);i=m.getContext("2d"),t(m),e=!0}i.drawImage(s,0,0),s.close()},onDone:async()=>{}})}const ce=class ce{constructor(t,e){d(this,Pe);k(this,"ready");d(this,P,[]);d(this,oe,{width:0,height:0,duration:0});d(this,N,{color:"#FFF",textBgColor:null,type:"srt",fontSize:30,letterSpacing:null,bottomOffset:30,fontFamily:"Noto Sans SC",strokeStyle:"#000",lineWidth:null,lineCap:null,lineJoin:null,textShadow:{offsetX:2,offsetY:2,blur:4,color:"#000"},videoWidth:1280,videoHeight:720});d(this,K);d(this,q);d(this,B,null);d(this,rt,0);d(this,at,0);var l;if(h(this,P,Array.isArray(t)?t:Ji(t).map(({start:m,end:u,text:w})=>({start:m*1e6,end:u*1e6,text:w}))),n(this,P).length===0)throw Error("No subtitles content");h(this,N,Object.assign(n(this,N),e)),h(this,at,e.textBgColor==null?0:(e.fontSize??50)*.2);const{fontSize:i,fontFamily:s,videoWidth:r,videoHeight:o,letterSpacing:c}=n(this,N);h(this,rt,i+n(this,at)*2),h(this,K,new OffscreenCanvas(r,o)),h(this,q,n(this,K).getContext("2d")),n(this,q).font=`${i}px ${s}`,n(this,q).textAlign="center",n(this,q).textBaseline="top",n(this,q).letterSpacing=c??"0px",h(this,oe,{width:r,height:o,duration:((l=n(this,P).at(-1))==null?void 0:l.end)??0}),this.ready=Promise.resolve(this.meta)}get meta(){return{...n(this,oe)}}async tick(t){var r,o;if(n(this,B)!=null&&t>=n(this,B).timestamp&&t<=n(this,B).timestamp+(n(this,B).duration??0))return{video:n(this,B).clone(),state:"success"};let e=0;for(;e<n(this,P).length&&!(t<=n(this,P)[e].end);e+=1);const i=n(this,P)[e]??n(this,P).at(-1);if(t>i.end)return{state:"done"};if(t<i.start){n(this,q).clearRect(0,0,n(this,K).width,n(this,K).height);const c=new VideoFrame(n(this,K),{timestamp:t,duration:i.start-t});return(r=n(this,B))==null||r.close(),h(this,B,c),{video:c.clone(),state:"success"}}L(this,Pe,gi).call(this,i.text);const s=new VideoFrame(n(this,K),{timestamp:t,duration:i.end-t});return(o=n(this,B))==null||o.close(),h(this,B,s),{video:s.clone(),state:"success"}}async split(t){await this.ready;let e=-1;for(let c=0;c<n(this,P).length;c++){const l=n(this,P)[c];if(!(t>l.start)){e=c;break}}if(e===-1)throw Error("Not found subtitle by time");const i=n(this,P).slice(0,e).map(c=>({...c}));let s=i.at(-1),r=null;s!=null&&s.end>t&&(r={start:0,end:s.end-t,text:s.text},s.end=t);const o=n(this,P).slice(e).map(c=>({...c,start:c.start-t,end:c.end-t}));return r!=null&&o.unshift(r),[new ce(i,n(this,N)),new ce(o,n(this,N))]}async clone(){return new ce(n(this,P).slice(0),n(this,N))}updateSubtitle(t){n(this,P).forEach(e=>{e.start===t.start&&e.end===t.end&&(e.text=t.text)})}getBottomOffset(){return n(this,N).bottomOffset}setBottomOffset(t){var e;if(typeof t!="number"||t<0)throw new Error("bottomOffset must be a non-negative number");n(this,N).bottomOffset=t,(e=n(this,B))==null||e.close(),h(this,B,null)}destroy(){var t;(t=n(this,B))==null||t.close()}};P=new WeakMap,oe=new WeakMap,N=new WeakMap,K=new WeakMap,q=new WeakMap,B=new WeakMap,rt=new WeakMap,at=new WeakMap,Pe=new WeakSet,gi=function(t){g.Log.info("renderTxt",t);const e=t.split(`
`).reverse().map(b=>b.trim()),{width:i,height:s}=n(this,K),{color:r,fontSize:o,textBgColor:c,textShadow:l,strokeStyle:m,lineWidth:u,lineCap:w,lineJoin:p,bottomOffset:x}=n(this,N),f=n(this,q);f.clearRect(0,0,i,s),f.globalAlpha=.6;let y=x;for(const b of e){const C=f.measureText(b),T=i/2;c!=null&&(f.shadowOffsetX=0,f.shadowOffsetY=0,f.shadowBlur=0,f.fillStyle=c,f.globalAlpha=.5,f.fillRect(T-C.actualBoundingBoxLeft-n(this,at),s-y-n(this,rt),C.width+n(this,at)*2,n(this,rt))),f.shadowColor=l.color,f.shadowOffsetX=l.offsetX,f.shadowOffsetY=l.offsetY,f.shadowBlur=l.blur,f.globalAlpha=1,m!=null&&(f.lineWidth=u??o/6,w!=null&&(f.lineCap=w),p!=null&&(f.lineJoin=p),f.strokeStyle=m,f.strokeText(b,T,s-y-n(this,rt)+n(this,at))),f.fillStyle=r,f.fillText(b,T,s-y-n(this,rt)+n(this,at)),y+=n(this,rt)+o*.2}};let We=ce;function oi(a){const t=a.match(/(\d{2}):(\d{2}):(\d{2}),(\d{3})/);if(t==null)throw Error(`time format error: ${a}`);const e=Number(t[1]),i=Number(t[2]),s=Number(t[3]),r=Number(t[4]);return e*60*60+i*60+s+r/1e3}function Ji(a){return a.split(/\r|\n/).map(t=>t.trim()).filter(t=>t.length>0).map(t=>({lineStr:t,match:t.match(/(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})/)})).filter(({lineStr:t},e,i)=>{var s;return!(/^\d+$/.test(t)&&((s=i[e+1])==null?void 0:s.match)!=null)}).reduce((t,{lineStr:e,match:i})=>{if(i==null){const s=t.at(-1);if(s==null)return t;s.text+=s.text.length===0?e:`
${e}`}else t.push({start:oi(i[1]),end:oi(i[2]),text:""});return t},[])}class ci{constructor(){k(this,"readable");k(this,"writable");d(this,le,0);const t=S.createFile();let e=!1;this.readable=new ReadableStream({start:i=>{t.onReady=r=>{var l,m;const o=(l=r.videoTracks[0])==null?void 0:l.id;o!=null&&t.setExtractionOptions(o,"video",{nbSamples:100});const c=(m=r.audioTracks[0])==null?void 0:m.id;c!=null&&t.setExtractionOptions(c,"audio",{nbSamples:100}),i.enqueue({chunkType:"ready",data:{info:r,file:t}}),t.start()};const s={};t.onSamples=(r,o,c)=>{i.enqueue({chunkType:"samples",data:{id:r,type:o,samples:c.map(l=>({...l}))}}),s[r]=(s[r]??0)+c.length,t.releaseUsedSamples(r,s[r])},t.onFlush=()=>{i.close()}},cancel:()=>{t.stop(),e=!0}},{highWaterMark:50}),this.writable=new WritableStream({write:async i=>{if(e){this.writable.abort();return}const s=i.buffer;s.fileStart=n(this,le),h(this,le,n(this,le)+s.byteLength),t.appendBuffer(s)},close:()=>{var i;t.flush(),t.stop(),(i=t.onFlush)==null||i.call(t)}})}}le=new WeakMap;function Yi(a){let t=0;const e=a.boxes,i=[];let s=0;async function r(){const f=x(e,t);t=e.length,i.forEach(({track:y,id:b})=>{const C=y.samples.at(-1);C!=null&&(s=Math.max(s,C.cts+C.duration)),a.releaseUsedSamples(b,y.samples.length),y.samples=[]}),a.mdats=[],a.moofs=[],f!=null&&await(u==null?void 0:u.write(f))}let o=[];function c(){if(o.length>0)return!0;const f=e.findIndex(y=>y.type==="moov");if(f===-1)return!1;if(o=e.slice(0,f+1),t=f+1,i.length===0)for(let y=1;;y+=1){const b=a.getTrackById(y);if(b==null)break;i.push({track:b,id:y})}return!0}let l=0;const m=Bt.tmpfile();let u=null;const w=(async()=>{u=await m.createWriter(),l=self.setInterval(()=>{c()&&r()},100)})();let p=!1;return async()=>{if(p)throw Error("File exported");if(p=!0,await w,clearInterval(l),!c()||u==null)return null;a.flush(),await r(),await(u==null?void 0:u.close());const f=o.find(C=>C.type==="moov");if(f==null)return null;f.mvhd.duration=s;const y=Bt.tmpfile(),b=x(o,0);return await Bt.write(y,b),await Bt.write(y,m,{overwrite:!1}),await y.stream()};function x(f,y){if(y>=f.length)return null;const b=new S.DataStream;b.endianness=S.DataStream.BIG_ENDIAN;for(let C=y;C<f.length;C++)f[C]!==null&&(f[C].write(b),delete f[C]);return new Uint8Array(b.buffer)}}function Qi(a){const t=new ArrayBuffer(a.byteLength);a.copyTo(t);const e=a.timestamp;return{duration:a.duration??0,dts:e,cts:e,is_sync:a.type==="key",data:t}}async function li(a){const t=S.createFile(),e=Yi(t);await Ui(a,t);const i=await e();if(i==null)throw Error("Can not generate file from streams");return i}async function Ui(a,t){let e=0,i=0,s=0,r=0,o=0,c=0,l=null,m=null;for(const u of a)await new Promise(async w=>{g.autoReadStream(u.pipeThrough(new ci),{onDone:w,onChunk:async({chunkType:p,data:x})=>{if(p==="ready"){const{videoTrackConf:f,audioTrackConf:y}=_e(x.file,x.info);e===0&&f!=null&&(e=t.addTrack(f)),r===0&&y!=null&&(r=t.addTrack(y))}else if(p==="samples"){const{type:f,samples:y}=x,b=f==="video"?e:r,C=f==="video"?i:o,T=f==="video"?s:c;y.forEach(R=>{t.addSample(b,R.data,{duration:R.duration,dts:R.dts+C,cts:R.cts+T,is_sync:R.is_sync})});const A=y.at(-1);if(A==null)return;f==="video"?l=A:f==="audio"&&(m=A)}}})}),l!=null&&(i+=l.dts,s+=l.cts),m!=null&&(o+=m.dts,c+=m.cts)}async function Ki(a){return await li([a])}function qi(a){let t=[];const e=new AudioDecoder({output:i=>{t.push(i)},error:g.Log.error});return e.configure(a),{decode:async i=>{i.forEach(r=>{e.decode(new EncodedAudioChunk({type:r.is_sync?"key":"delta",timestamp:1e6*r.cts/r.timescale,duration:1e6*r.duration/r.timescale,data:r.data}))}),await e.flush();const s=t;return t=[],s},close:()=>{e.close()}}}function Zi(a,t){const e={codec:a.codec,sampleRate:a.sampleRate,numberOfChannels:a.numberOfChannels},i=new AudioEncoder({output:o=>{t(Qi(o))},error:o=>{g.Log.error("AudioEncoder error:",o,", config:",e)}});i.configure(e);let s=null;function r(o,c){return new AudioData({timestamp:c,numberOfChannels:a.numberOfChannels,numberOfFrames:o.length/a.numberOfChannels,sampleRate:a.sampleRate,format:"f32-planar",data:o})}return{encode:async(o,c)=>{s!=null&&i.encode(r(s.data,s.ts)),s={data:o,ts:c}},stop:async()=>{s!=null&&(tn(s.data,a.numberOfChannels,a.sampleRate),i.encode(r(s.data,s.ts)),s=null),await i.flush(),i.close()}}}function tn(a,t,e){const i=a.length-1,s=Math.min(e/2,i);for(let r=0;r<s;r++)for(let o=1;o<=t;o++)a[Math.floor(i/o)-r]*=r/s}function en(a,t){g.Log.info("mixinMP4AndAudio, opts:",{volume:t.volume,loop:t.loop});const e=S.createFile(),{stream:i,stop:s}=g.file2stream(e,500);let r=null,o=null,c=[],l=0,m=0,u=0,w=!0,p=I.sampleRate;g.autoReadStream(a.pipeThrough(new ci),{onDone:async()=>{await(o==null?void 0:o.stop()),r==null||r.close(),s()},onChunk:async({chunkType:b,data:C})=>{if(b==="ready"){const{videoTrackConf:T,audioTrackConf:A,audioDecoderConf:R}=_e(C.file,C.info);l===0&&T!=null&&(l=e.addTrack(T));const et=A??{timescale:1e6,samplerate:p,channel_count:I.channelCount,hdlr:"soun",name:"SoundHandler",type:"mp4a"};m===0&&(m=e.addTrack(et),p=(A==null?void 0:A.samplerate)??p,w=A!=null);const vn=new AudioContext({sampleRate:p});c=De(await vn.decodeAudioData(await new Response(t.stream).arrayBuffer())),R!=null&&(r=qi(R)),o=Zi(R??{codec:et.type==="mp4a"?I.codec:et.type,numberOfChannels:et.channel_count,sampleRate:et.samplerate},fi=>e.addSample(m,fi.data,fi))}else if(b==="samples"){const{id:T,type:A,samples:R}=C;if(A==="video"){R.forEach(et=>e.addSample(T,et.data,et)),w||await f(R);return}A==="audio"&&await y(R)}}});function x(b){const C=c.map(T=>t.loop?Be(T,u,u+b):T.slice(u,u+b));if(u+=b,t.volume!==1)for(const T of C)for(let A=0;A<T.length;A++)T[A]*=t.volume;return C}async function f(b){const C=b[0],T=b[b.length-1],A=Math.floor((T.cts+T.duration-C.cts)/T.timescale*p),R=Ze([x(A)]);R.length!==0&&(o==null||o.encode(R,C.cts/C.timescale*1e6))}async function y(b){if(r==null)return;const C=(await r.decode(b)).map(qe),T=ki(C),A=x(T[0].length),R=b[0];o==null||o.encode(Ze([T,A]),R.cts/R.timescale*1e6)}return i}const nn=`#version 300 es
  layout (location = 0) in vec4 a_position;
  layout (location = 1) in vec2 a_texCoord;
  out vec2 v_texCoord;
  void main () {
    gl_Position = a_position;
    v_texCoord = a_texCoord;
  }
`,sn=`#version 300 es
precision mediump float;
out vec4 FragColor;
in vec2 v_texCoord;

uniform sampler2D frameTexture;
uniform vec3 keyColor;

// 色度的相似度计算
uniform float similarity;
// 透明度的平滑度计算
uniform float smoothness;
// 降低绿幕饱和度，提高抠图准确度
uniform float spill;

vec2 RGBtoUV(vec3 rgb) {
  return vec2(
    rgb.r * -0.169 + rgb.g * -0.331 + rgb.b *  0.5    + 0.5,
    rgb.r *  0.5   + rgb.g * -0.419 + rgb.b * -0.081  + 0.5
  );
}

void main() {
  // 获取当前像素的rgba值
  vec4 rgba = texture(frameTexture, v_texCoord);
  // 计算当前像素与绿幕像素的色度差值
  vec2 chromaVec = RGBtoUV(rgba.rgb) - RGBtoUV(keyColor);
  // 计算当前像素与绿幕像素的色度距离（向量长度）, 越相像则色度距离越小
  float chromaDist = sqrt(dot(chromaVec, chromaVec));
  // 设置了一个相似度阈值，baseMask为负，则表明是绿幕，为正则表明不是绿幕
  float baseMask = chromaDist - similarity;
  // 如果baseMask为负数，fullMask等于0；baseMask为正数，越大，则透明度越低
  float fullMask = pow(clamp(baseMask / smoothness, 0., 1.), 1.5);
  rgba.a = fullMask; // 设置透明度
  // 如果baseMask为负数，spillVal等于0；baseMask为整数，越小，饱和度越低
  float spillVal = pow(clamp(baseMask / spill, 0., 1.), 1.5);
  float desat = clamp(rgba.r * 0.2126 + rgba.g * 0.7152 + rgba.b * 0.0722, 0., 1.); // 计算当前像素的灰度值
  rgba.rgb = mix(vec3(desat, desat, desat), rgba.rgb, spillVal);
  FragColor = rgba;
}
`,rn=[-1,1,-1,-1,1,-1,1,-1,1,1,-1,1],an=[0,1,0,0,1,0,1,0,1,1,0,1];function on(a,t,e){const i=hi(a,a.VERTEX_SHADER,t),s=hi(a,a.FRAGMENT_SHADER,e),r=a.createProgram();if(a.attachShader(r,i),a.attachShader(r,s),a.linkProgram(r),!a.getProgramParameter(r,a.LINK_STATUS))throw Error(a.getProgramInfoLog(r)??"Unable to initialize the shader program");return r}function hi(a,t,e){const i=a.createShader(t);if(a.shaderSource(i,e),a.compileShader(i),!a.getShaderParameter(i,a.COMPILE_STATUS)){const s=a.getShaderInfoLog(i);throw a.deleteShader(i),Error(s??"An error occurred compiling the shaders")}return i}function cn(a,t,e){a.bindTexture(a.TEXTURE_2D,e),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,t),a.drawArrays(a.TRIANGLES,0,6)}function ln(a){const t=a.createTexture();if(t==null)throw Error("Create WebGL texture error");a.bindTexture(a.TEXTURE_2D,t);const e=0,i=a.RGBA,s=1,r=1,o=0,c=a.RGBA,l=a.UNSIGNED_BYTE,m=new Uint8Array([0,0,255,255]);return a.texImage2D(a.TEXTURE_2D,e,i,s,r,o,c,l,m),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),t}function hn(a){const t="document"in globalThis?globalThis.document.createElement("canvas"):new OffscreenCanvas(a.width,a.height);t.width=a.width,t.height=a.height;const e=t.getContext("webgl2",{premultipliedAlpha:!1,alpha:!0});if(e==null)throw Error("Cant create gl context");const i=on(e,nn,sn);e.useProgram(i),e.uniform3fv(e.getUniformLocation(i,"keyColor"),a.keyColor.map(l=>l/255)),e.uniform1f(e.getUniformLocation(i,"similarity"),a.similarity),e.uniform1f(e.getUniformLocation(i,"smoothness"),a.smoothness),e.uniform1f(e.getUniformLocation(i,"spill"),a.spill);const s=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,new Float32Array(rn),e.STATIC_DRAW);const r=e.getAttribLocation(i,"a_position");e.vertexAttribPointer(r,2,e.FLOAT,!1,Float32Array.BYTES_PER_ELEMENT*2,0),e.enableVertexAttribArray(r);const o=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,o),e.bufferData(e.ARRAY_BUFFER,new Float32Array(an),e.STATIC_DRAW);const c=e.getAttribLocation(i,"a_texCoord");return e.vertexAttribPointer(c,2,e.FLOAT,!1,Float32Array.BYTES_PER_ELEMENT*2,0),e.enableVertexAttribArray(c),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1),{cvs:t,gl:e}}function dn(a){return a instanceof VideoFrame?{width:a.codedWidth,height:a.codedHeight}:{width:a.width,height:a.height}}function un(a){const e=new OffscreenCanvas(1,1).getContext("2d");e.drawImage(a,0,0);const{data:[i,s,r]}=e.getImageData(0,0,1,1);return[i,s,r]}const fn=a=>{let t=null,e=null,i=a.keyColor,s=null;return async r=>{if((t==null||e==null||s==null)&&(i==null&&(i=un(r)),{cvs:t,gl:e}=hn({...dn(r),keyColor:i,...a}),s=ln(e)),cn(e,r,s),globalThis.VideoFrame!=null&&r instanceof globalThis.VideoFrame){const o=new VideoFrame(t,{alpha:"keep",timestamp:r.timestamp,duration:r.duration??void 0});return r.close(),o}return createImageBitmap(t,{imageOrientation:r instanceof ImageBitmap?"flipY":"none"})}},Je=class Je{constructor(t,e,i,s,r){d(this,ut);d(this,he,new g.EventTool);k(this,"on",n(this,he).on);d(this,de,0);d(this,ue,0);d(this,fe,0);d(this,me,0);d(this,pe,0);d(this,ft,null);k(this,"fixedAspectRatio",!1);k(this,"fixedScaleCenter",!1);this.x=t??0,this.y=e??0,this.w=i??0,this.h=s??0,h(this,ft,r??null)}get x(){return n(this,de)}set x(t){L(this,ut,Yt).call(this,"x",t)}get y(){return n(this,ue)}set y(t){L(this,ut,Yt).call(this,"y",t)}get w(){return n(this,fe)}set w(t){L(this,ut,Yt).call(this,"w",t)}get h(){return n(this,me)}set h(t){L(this,ut,Yt).call(this,"h",t)}get angle(){return n(this,pe)}set angle(t){L(this,ut,Yt).call(this,"angle",t)}get center(){const{x:t,y:e,w:i,h:s}=this;return{x:t+i/2,y:e+s/2}}clone(){const{x:t,y:e,w:i,h:s}=this,r=new Je(t,e,i,s,n(this,ft));return r.angle=this.angle,r.fixedAspectRatio=this.fixedAspectRatio,r.fixedScaleCenter=this.fixedScaleCenter,r}checkHit(t,e){var y,b;let{angle:i,center:s,x:r,y:o,w:c,h:l}=this;const m=((y=n(this,ft))==null?void 0:y.center)??s,u=((b=n(this,ft))==null?void 0:b.angle)??i;n(this,ft)==null&&(r=r-m.x,o=o-m.y);const w=t-m.x,p=e-m.y;let x=w,f=p;return u!==0&&(x=w*Math.cos(u)+p*Math.sin(u),f=p*Math.cos(u)-w*Math.sin(u)),!(x<r||x>r+c||f<o||f>o+l)}};he=new WeakMap,de=new WeakMap,ue=new WeakMap,fe=new WeakMap,me=new WeakMap,pe=new WeakMap,ut=new WeakSet,Yt=function(t,e){const i=this[t]!==e;switch(t){case"x":h(this,de,e);break;case"y":h(this,ue,e);break;case"w":h(this,fe,e);break;case"h":h(this,me,e);break;case"angle":h(this,pe,e);break}i&&n(this,he).emit("propsChange",{[t]:e})},ft=new WeakMap;let Te=Je;class di{constructor(){k(this,"rect",new Te);d(this,we,{offset:0,duration:0,playbackRate:1});d(this,Ft,new g.EventTool);k(this,"on",n(this,Ft).on);d(this,$t,0);k(this,"opacity",1);k(this,"flip",null);d(this,mt,null);d(this,Z,null);k(this,"ready",Promise.resolve());this.rect.on("propsChange",t=>{n(this,Ft).emit("propsChange",{rect:t})})}get time(){return n(this,we)}set time(t){Object.assign(n(this,we),t)}get zIndex(){return n(this,$t)}set zIndex(t){const e=n(this,$t)!==t;h(this,$t,t),e&&n(this,Ft).emit("propsChange",{zIndex:t})}_render(t){const{rect:{center:e,angle:i}}=this;t.setTransform(this.flip==="horizontal"?-1:1,0,0,this.flip==="vertical"?-1:1,e.x,e.y),t.rotate((this.flip==null?1:-1)*i),t.globalAlpha=this.opacity}setAnimation(t,e){h(this,mt,Object.entries(t).map(([i,s])=>{const r={from:0,to:100}[i]??Number(i.slice(0,-1));if(isNaN(r)||r>100||r<0)throw Error("keyFrame must between 0~100");return[r/100,s]})),h(this,Z,Object.assign({},n(this,Z),{duration:e.duration,delay:e.delay??0,iterCount:e.iterCount??1/0}))}animate(t){if(n(this,mt)==null||n(this,Z)==null||t<n(this,Z).delay)return;const e=mn(t,n(this,mt),n(this,Z));for(const i in e)switch(i){case"opacity":this.opacity=e[i];break;case"x":case"y":case"w":case"h":case"angle":this.rect[i]=e[i];break}}copyStateTo(t){h(t,mt,n(this,mt)),h(t,Z,n(this,Z)),t.zIndex=this.zIndex,t.opacity=this.opacity,t.flip=this.flip,t.rect=this.rect.clone(),t.time={...this.time}}destroy(){n(this,Ft).destroy()}}we=new WeakMap,Ft=new WeakMap,$t=new WeakMap,mt=new WeakMap,Z=new WeakMap;function mn(a,t,e){const i=a-e.delay;if(i/e.duration>=e.iterCount)return{};const s=i%e.duration,r=i===e.duration?1:s/e.duration,o=t.findIndex(x=>x[0]>=r);if(o===-1)return{};const c=t[o-1],l=t[o],m=l[1];if(c==null)return m;const u=c[1],w={},p=(r-c[0])/(l[0]-c[0]);for(const x in m){const f=x;u[f]!=null&&(w[f]=(m[f]-u[f])*p+u[f])}return w}const Ye=class Ye extends di{constructor(e){super();d(this,Et);d(this,pt,null);d(this,ge,!1);h(this,Et,e),this.ready=e.ready.then(({width:i,height:s,duration:r})=>{this.rect.w=this.rect.w===0?i:this.rect.w,this.rect.h=this.rect.h===0?s:this.rect.h,this.time.duration=this.time.duration===0?r:this.time.duration})}async offscreenRender(e,i){var p;const s=i*this.time.playbackRate;this.animate(s),super._render(e);const{w:r,h:o}=this.rect,{video:c,audio:l,state:m}=await n(this,Et).tick(s);let u=l??[];if(l!=null&&this.time.playbackRate!==1&&(u=l.map(x=>ti(x,this.time.playbackRate))),m==="done")return{audio:u,done:!0};const w=c??n(this,pt);return w!=null&&e.drawImage(w,-r/2,-o/2,r,o),c!=null&&((p=n(this,pt))==null||p.close(),h(this,pt,c)),{audio:u,done:!1}}async clone(){const e=new Ye(await n(this,Et).clone());return await e.ready,this.copyStateTo(e),e}destroy(){var e;n(this,ge)||(h(this,ge,!0),g.Log.info("OffscreenSprite destroy"),super.destroy(),(e=n(this,pt))==null||e.close(),h(this,pt,null),n(this,Et).destroy())}};Et=new WeakMap,pt=new WeakMap,ge=new WeakMap;let Xe=Ye;const Qe=class Qe extends di{constructor(e){super();d(this,ye);d(this,jt);k(this,"visible",!0);d(this,wt,null);d(this,Pt,[]);d(this,Wt,!1);d(this,Dt,-1);d(this,be,!1);h(this,jt,e),this.ready=e.ready.then(({width:i,height:s,duration:r})=>{this.rect.w=this.rect.w===0?i:this.rect.w,this.rect.h=this.rect.h===0?s:this.rect.h,this.time.duration=this.time.duration===0?r:this.time.duration})}getClip(){return n(this,jt)}preFrame(e){n(this,Dt)!==e&&(L(this,ye,Ke).call(this,e),h(this,Dt,e))}render(e,i){this.animate(i),super._render(e);const{w:s,h:r}=this.rect;n(this,Dt)!==i&&L(this,ye,Ke).call(this,i),h(this,Dt,i);const o=n(this,Pt);h(this,Pt,[]);const c=n(this,wt);return c!=null&&e.drawImage(c,-s/2,-r/2,s,r),{audio:o}}copyStateTo(e){super.copyStateTo(e),e instanceof Qe&&(e.visible=this.visible)}destroy(){var e;n(this,be)||(h(this,be,!0),g.Log.info("VisibleSprite destroy"),super.destroy(),(e=n(this,wt))==null||e.close(),h(this,wt,null))}};jt=new WeakMap,wt=new WeakMap,Pt=new WeakMap,Wt=new WeakMap,ye=new WeakSet,Ke=function(e){n(this,Wt)||(h(this,Wt,!0),n(this,jt).tick(e*this.time.playbackRate).then(({video:i,audio:s})=>{var r;i!=null&&((r=n(this,wt))==null||r.close(),h(this,wt,i??null)),h(this,Pt,s??[]),s!=null&&this.time.playbackRate!==1&&h(this,Pt,s.map(o=>ti(o,this.time.playbackRate)))}).finally(()=>{h(this,Wt,!1)}))},Dt=new WeakMap,be=new WeakMap;let Ge=Qe,pn=0;async function ui(a){a()>50&&(await Oe(15),await ui(a))}class wn{constructor(t={}){d(this,Jt);d(this,tt,g.Log.create(`id:${pn++},`));d(this,Ce,!1);d(this,W,[]);d(this,Xt);d(this,ve);d(this,xe,null);d(this,Ot);d(this,Gt);d(this,gt,new g.EventTool);k(this,"on",n(this,gt).on);const{width:e=0,height:i=0}=t;h(this,Xt,new OffscreenCanvas(e,i));const s=n(this,Xt).getContext("2d",{alpha:!1});if(s==null)throw Error("Can not create 2d offscreen context");h(this,ve,s),h(this,Ot,Object.assign({bgColor:"#000",width:0,height:0,videoCodec:"avc1.42E032",audio:!0,bitrate:5e6,fps:30,metaDataTags:null},t)),h(this,Gt,e*i>0)}static async isSupported(t={}){return(self.OffscreenCanvas!=null&&self.VideoEncoder!=null&&self.VideoDecoder!=null&&self.VideoFrame!=null&&self.AudioEncoder!=null&&self.AudioDecoder!=null&&self.AudioData!=null&&((await self.VideoEncoder.isConfigSupported({codec:t.videoCodec??"avc1.42E032",width:t.width??1920,height:t.height??1080,bitrate:t.bitrate??7e6})).supported??!1)&&(await self.AudioEncoder.isConfigSupported({codec:I.codec,sampleRate:I.sampleRate,numberOfChannels:I.channelCount})).supported)??!1}async addSprite(t,e={}){const i={rect:Cn(["x","y","w","h"],t.rect),time:{...t.time},zIndex:t.zIndex};n(this,tt).info("Combinator add sprite",i);const s=await t.clone();n(this,tt).info("Combinator add sprite ready"),n(this,W).push(Object.assign(s,{main:e.main??!1,expired:!1})),n(this,W).sort((r,o)=>r.zIndex-o.zIndex)}output(){if(n(this,W).length===0)throw Error("No sprite added");const t=n(this,W).find(l=>l.main),e=t!=null?t.time.offset+t.time.duration:Math.max(...n(this,W).map(l=>l.time.offset+l.time.duration));if(e===1/0)throw Error("Unable to determine the end time, please specify a main sprite, or limit the duration of ImgClip, AudioCli");e===-1&&n(this,tt).warn("Unable to determine the end time, process value don't update"),n(this,tt).info(`start combinate video, maxTime:${e}`);const i=L(this,Jt,yi).call(this,e);let s=performance.now();const r=L(this,Jt,bi).call(this,i,e,{onProgress:l=>{n(this,tt).debug("OutputProgress:",l),n(this,gt).emit("OutputProgress",l)},onEnded:async()=>{await i.flush(),n(this,tt).info("===== output ended =====, cost:",performance.now()-s),n(this,gt).emit("OutputProgress",1),this.destroy()},onError:l=>{n(this,gt).emit("error",l),c(l),this.destroy()}});h(this,xe,()=>{r(),i.close(),c()});const{stream:o,stop:c}=g.file2stream(i.mp4file,500,this.destroy);return o}destroy(){var t;n(this,Ce)||(h(this,Ce,!0),(t=n(this,xe))==null||t.call(this),n(this,gt).destroy())}}tt=new WeakMap,Ce=new WeakMap,W=new WeakMap,Xt=new WeakMap,ve=new WeakMap,xe=new WeakMap,Ot=new WeakMap,Gt=new WeakMap,gt=new WeakMap,Jt=new WeakSet,yi=function(t){const{fps:e,width:i,height:s,videoCodec:r,bitrate:o,audio:c,metaDataTags:l}=n(this,Ot);return g.recodemux({video:n(this,Gt)?{width:i,height:s,expectFPS:e,codec:r,bitrate:o,__unsafe_hardwareAcceleration__:n(this,Ot).__unsafe_hardwareAcceleration__}:null,audio:c===!1?null:{codec:"aac",sampleRate:I.sampleRate,channelCount:I.channelCount},duration:t,metaDataTags:l})},bi=function(t,e,{onProgress:i,onEnded:s,onError:r}){let o=0;const c={aborted:!1};let l=null;(async()=>{const{fps:p,bgColor:x,audio:f}=n(this,Ot),y=Math.round(1e6/p),b=n(this,ve),C=gn({ctx:b,bgColor:x,sprites:n(this,W),aborter:c}),T=yn({remux:t,ctx:b,cvs:n(this,Xt),outputAudio:f,hasVideoTrack:n(this,Gt),timeSlice:y,fps:p});let A=0;for(;;){if(l!=null)return;if(c.aborted||e!==-1&&A>e||n(this,W).length===0){w(),await s();return}o=A/e;const{audios:R,mainSprDone:et}=await C(A);if(et){w(),await s();return}if(c.aborted)return;T(A,R),A+=y,await ui(t.getEncodeQueueSize)}})().catch(p=>{l=p,n(this,tt).error(p),w(),r(p)});const u=setInterval(()=>{i(o)},500),w=()=>{c.aborted||(c.aborted=!0,clearInterval(u),n(this,W).forEach(p=>p.destroy()))};return w};function gn(a){const{ctx:t,bgColor:e,sprites:i,aborter:s}=a,{width:r,height:o}=t.canvas;return async c=>{t.fillStyle=e,t.fillRect(0,0,r,o);const l=[];let m=!1;for(const u of i){if(s.aborted)break;if(c<u.time.offset||u.expired)continue;t.save();const{audio:w,done:p}=await u.offscreenRender(t,c-u.time.offset);l.push(w),t.restore(),(u.time.duration>0&&c>u.time.offset+u.time.duration||p)&&(u.main&&(m=!0),u.destroy(),u.expired=!0)}return{audios:l,mainSprDone:m}}}function yn(a){const{ctx:t,cvs:e,outputAudio:i,remux:s,hasVideoTrack:r,timeSlice:o}=a,{width:c,height:l}=e;let m=0;const u=Math.floor(3*a.fps),w=bn(1024);return(p,x)=>{if(i!==!1)for(const f of w(p,x))s.encodeAudio(f);if(r){const f=new VideoFrame(e,{duration:o,timestamp:p});s.encodeVideo(f,{keyFrame:m%u===0}),t.resetTransform(),t.clearRect(0,0,c,l),m+=1}}}function bn(a){const t=a*I.channelCount,e=new Float32Array(t*3);let i=0,s=0;const r=a/I.sampleRate*1e6,o=new Float32Array(t),c=l=>{let m=0;const u=Math.floor(i/t),w=[];for(let p=0;p<u;p++)w.push(new AudioData({timestamp:s,numberOfChannels:I.channelCount,numberOfFrames:a,sampleRate:I.sampleRate,format:"f32",data:e.subarray(m,m+t)})),m+=t,s+=r;for(e.set(e.subarray(m,i),0),i-=m;l-s>r;)w.push(new AudioData({timestamp:s,numberOfChannels:I.channelCount,numberOfFrames:a,sampleRate:I.sampleRate,format:"f32",data:o})),s+=r;return w};return(l,m)=>{var w,p;const u=Math.max(...m.map(x=>{var f;return((f=x[0])==null?void 0:f.length)??0}));for(let x=0;x<u;x++){let f=0,y=0;for(let b=0;b<m.length;b++){const C=((w=m[b][0])==null?void 0:w[x])??0,T=((p=m[b][1])==null?void 0:p[x])??C;f+=C,y+=T}e[i]=f,e[i+1]=y,i+=2}return c(l)}}function Cn(a,t){return a.reduce((e,i)=>(e[i]=t[i],e),{})}Object.defineProperty(v,"Log",{enumerable:!0,get:()=>g.Log}),v.AudioClip=$e,v.Combinator=wn,v.EmbedSubtitlesClip=We,v.ImgClip=He,v.MP4Clip=ze,v.MediaStreamClip=je,v.OffscreenSprite=Xe,v.Rect=Te,v.VisibleSprite=Ge,v.createChromakey=fn,v.fastConcatMP4=li,v.fixFMP4Duration=Ki,v.mixinMP4AndAudio=en,v.renderTxt2ImgBitmap=Ti,Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=av-cliper.umd.cjs.map
